version: "3.9"

services:
  metabase:
    image: metabase/metabase:latest
    container_name: metabase-git
    hostname: metabase
    volumes:
      - /dev/urandom:/dev/random:ro
    env_file:
      - .env
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabaseappdb
      MB_DB_PORT: 5432
      MB_DB_USER: ${MB_DB_USER}
      MB_DB_PASS: ${MB_DB_PASS}
      MB_DB_HOST: postgres
      MB_SITE_URL: https://bi.zamdatalabs.com
    networks:
      - dokploy-network
      - metanet1

    labels:
      - "traefik.enable=true"

      # Secure (HTTPS) route
      - "traefik.http.routers.metabase.rule=Host(`bi.zamdatalabs.com`)"
      - "traefik.http.routers.metabase.entrypoints=websecure"
      - "traefik.http.routers.metabase.tls.certresolver=letsencrypt"

      # HTTP â†’ HTTPS redirect
      - "traefik.http.routers.metabase-redirect.entrypoints=web"
      - "traefik.http.routers.metabase-redirect.rule=Host(`bi.zamdatalabs.com`)"
      - "traefik.http.routers.metabase-redirect.middlewares=redirect-to-https@docker"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # Internal Metabase port
      - "traefik.http.services.metabase.loadbalancer.server.port=3000"

    healthcheck:
      test: curl --fail -I http://localhost:3000/api/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:latest
    container_name: postgres-git
    hostname: postgres
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${MB_DB_USER}
      POSTGRES_DB: metabaseappdb
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    networks:
      - metanet1

# ----------------------------
# Networks
# ----------------------------
networks:
  metanet1:
    driver: bridge
  dokploy-network:
    external: true
